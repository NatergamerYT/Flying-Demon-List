{% extends "base.html" %}

{% block title %}Manage Ranks - {{ level.name }}{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h1 class="display-5 fw-bold">Manage Ranks: {{ level.name }}</h1>
        <p class="lead">Assign ranks 1-50 to claims. Changes save automatically.</p>
        <a href="{{ url_for('admin.levels') }}" class="btn btn-secondary">Back to Levels</a>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="alert alert-info">
            <strong>Ranked:</strong> {{ rank_info.ranked_count }}/50 |
            <strong>Unranked:</strong> {{ rank_info.unranked_count }} |
            {% if rank_info.next_available_rank %}
                <strong>Next Available:</strong> #{{ rank_info.next_available_rank }}
            {% else %}
                <strong>Status:</strong> Level is full (50/50)
            {% endif %}
        </div>

        {% if claims %}
            <div class="table-responsive">
                <table class="table table-hover table-striped">
                    <thead class="table-dark">
                        <tr>
                            <th style="width: 120px;">Rank</th>
                            <th>User</th>
                            <th>Points</th>
                            <th style="width: 140px;">First Victor</th>
                            <th>Submitted</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="claims-table">
                        {% for claim in claims %}
                        <tr data-claim-id="{{ claim.id }}">
                            <td>
                                <input type="number"
                                       class="form-control form-control-sm rank-input"
                                       value="{{ claim.rank or '' }}"
                                       placeholder="Unranked"
                                       min="1"
                                       max="50"
                                       data-claim-id="{{ claim.id }}"
                                       style="width: 90px;">
                            </td>
                            <td>
                                <a href="{{ url_for('users.profile', username=claim.user.username) }}">
                                    {% if claim.user.profile_picture %}
                                        <img src="{{ url_for('static', filename='uploads/' + claim.user.profile_picture) }}" alt="Profile" class="rounded-circle me-2" style="width: 20px; height: 20px; object-fit: cover;">
                                    {% endif %}
                                    {{ claim.user.username }}
                                </a>
                            </td>
                            <td><span class="badge bg-primary">{{ claim.points }} pts</span></td>
                            <td class="text-center">
                                <input type="checkbox"
                                       class="form-check-input first-victor-checkbox"
                                       {% if claim.is_first_victor %}checked{% endif %}
                                       data-claim-id="{{ claim.id }}"
                                       title="Mark as First Victor (only one per level)">
                            </td>
                            <td>{{ claim.submitted_at.strftime('%b %d, %Y') }}</td>
                            <td>
                                <a href="{{ claim.youtube_link }}" target="_blank" class="btn btn-sm btn-outline-primary">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-youtube" viewBox="0 0 16 16">
                                        <path d="M8.051 1.999h.089c.822.003 4.987.033 6.11.335a2.01 2.01 0 0 1 1.415 1.42c.101.38.172.883.22 1.402l.01.104.022.26.008.104c.065.914.073 1.77.074 1.957v.075c-.001.194-.01 1.108-.082 2.06l-.008.105-.009.104c-.05.572-.124 1.14-.235 1.558a2.007 2.007 0 0 1-1.415 1.42c-1.16.312-5.569.334-6.18.335h-.142c-.309 0-1.587-.006-2.927-.052l-.17-.006-.087-.004-.171-.007-.171-.007c-1.11-.049-2.167-.128-2.654-.26a2.007 2.007 0 0 1-1.415-1.419c-.111-.417-.185-.986-.235-1.558L.09 9.82l-.008-.104A31.4 31.4 0 0 1 0 7.68v-.123c.002-.215.01-.958.064-1.778l.007-.103.003-.052.008-.104.022-.26.01-.104c.048-.519.119-1.023.22-1.402a2.007 2.007 0 0 1 1.415-1.42c.487-.13 1.544-.21 2.654-.26l.17-.007.172-.006.086-.003.171-.007A99.788 99.788 0 0 1 7.858 2h.193zM6.4 5.209v4.818l4.157-2.408L6.4 5.209z"/>
                                    </svg>
                                    Video
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <div class="alert alert-warning">
                No approved claims found for this level.
            </div>
        {% endif %}
    </div>
</div>

<script>
// AJAX rank update on input change
document.addEventListener('DOMContentLoaded', function() {
    const csrfToken = '{{ csrf_token() }}';

    document.querySelectorAll('.rank-input').forEach(input => {
        let timeoutId;

        input.addEventListener('input', function() {
            clearTimeout(timeoutId);
            const claimId = this.dataset.claimId;
            const newRank = this.value;
            const inputElement = this;

            // Clear previous styling
            inputElement.classList.remove('border-success', 'border-danger');

            // Debounce for 800ms
            timeoutId = setTimeout(() => {
                fetch(`/admin/update-rank/${claimId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({ rank: newRank })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Show success feedback
                        inputElement.classList.add('border-success');
                        setTimeout(() => {
                            inputElement.classList.remove('border-success');
                        }, 2000);

                        // Update points display
                        const row = inputElement.closest('tr');
                        const pointsBadge = row.querySelector('.badge');
                        if (pointsBadge) {
                            pointsBadge.textContent = `${data.new_points} pts`;
                        }

                        // Optionally reload to show reordering
                        setTimeout(() => {
                            location.reload();
                        }, 1000);
                    } else {
                        inputElement.classList.add('border-danger');
                        alert(data.message);
                        setTimeout(() => {
                            inputElement.classList.remove('border-danger');
                        }, 3000);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    inputElement.classList.add('border-danger');
                    alert('Failed to update rank. Please try again.');
                });
            }, 800);
        });

        // Allow clearing with backspace
        input.addEventListener('keydown', function(e) {
            if (e.key === 'Backspace' || e.key === 'Delete') {
                // Allow clearing the field
            }
        });
    });

    // First Victor checkbox handler
    document.querySelectorAll('.first-victor-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const claimId = this.dataset.claimId;
            const isFirstVictor = this.checked;
            const checkboxElement = this;

            fetch(`/admin/toggle-first-victor/${claimId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({ is_first_victor: isFirstVictor })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // If this claim became first victor, uncheck all others
                    if (isFirstVictor) {
                        document.querySelectorAll('.first-victor-checkbox').forEach(cb => {
                            if (cb !== checkboxElement) {
                                cb.checked = false;
                            }
                        });
                    }

                    // Show success feedback briefly
                    const row = checkboxElement.closest('tr');
                    row.style.backgroundColor = '#d4edda';
                    setTimeout(() => {
                        row.style.backgroundColor = '';
                    }, 1500);
                } else {
                    // Revert checkbox state on error
                    checkboxElement.checked = !isFirstVictor;
                    alert(data.message || 'Failed to update First Victor status.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                checkboxElement.checked = !isFirstVictor;
                alert('Failed to update First Victor status. Please try again.');
            });
        });
    });
});
</script>
{% endblock %}
